#!/usr/bin/env php
<?php

ini_set('memory_limit', '1024M');
set_time_limit(0);

$prevHandler = set_error_handler(function (int $errNo, string $errstr) use (&$prevHandler): bool {
    if ($errNo === E_USER_ERROR && strpos($errstr, 'Your Composer dependencies require a PHP version') !== false) {
        $message = 'If you have multiple PHP versions installed on your machine, install "tareqas/psym" globally on the lowest version. It supports PHP >= 7.2';
        echo "\e[41m\e[97m$message\e[0m\n\n";
        die();
    }

    return null !== $prevHandler ? $prevHandler(...func_get_args()) : false;
});

$autoloaderUserFile = getcwd().'/vendor/autoload.php';
$autoloaderSfFile = __DIR__.'/../vendor-sf/autoload.php';
$autoloaderSf7File = __DIR__.'/../vendor-sf7/autoload.php';
$autoloaderDefaultFile = __DIR__.'/../vendor/autoload.php';
require __DIR__.'/../src/SFChecker.php';

$sfChecker = new \TareqAS\Psym\SFChecker(getcwd());

if (file_exists($autoloaderUserFile)) {
    $autoloaderUser = require $autoloaderUserFile;
    $autoloaderSf = require $sfChecker->isSymfony7() ? $autoloaderSf7File : $autoloaderSfFile;
} else {
    $autoloaderDefault = require $autoloaderDefaultFile;
}
restore_error_handler();

$shell = function () {
    $config = new \Psy\Configuration();
    $config->setAutoCompleter(new \TareqAS\Psym\TabCompletion\AutoCompleter());
    return new \Psy\Shell($config);
};

$sfLoader = new \TareqAS\Psym\SFLoader(getcwd());

if ($sfChecker->isSymfonyApp() && $sfLoader->getKernelInstance()) {
    [$kernel, $container, $doctrine, $em] = $sfLoader->getUsefulServices();
    $commands = $sfLoader->getAllCommands();
    array_unshift($commands, new \TareqAS\Psym\Command\ListEntitiesCommand());

    $sh = $shell();
    $sh->setScopeVariables(compact('kernel', 'container', 'doctrine', 'em'));
    $sh->addCommands($commands);
    $sh->addMatchers([
        new \TareqAS\Psym\TabCompletion\Matcher\SqlDqlMatcher(),
        new \TareqAS\Psym\TabCompletion\Matcher\MethodChainingMatcher(),
    ]);
    $sh->run();
} else {
    if (isset($autoloaderUser, $autoloaderSf)) {
        $autoloaderUser->unregister();
        $autoloaderSf->unregister();
    }

    if (!isset($autoloaderDefault)) {
        require $autoloaderDefaultFile;
    }

    $sh = $shell();
    $sh->addMatchers([
        new \TareqAS\Psym\TabCompletion\Matcher\MethodChainingMatcher(),
    ]);
    $sh->run();
}
