#!/usr/bin/env php
<?php

ini_set('memory_limit', '1024M');
set_time_limit(0);

$prevHandler = set_error_handler(function (int $errNo, string $errstr) use (&$prevHandler): bool {
    if ($errNo === E_USER_ERROR && strpos($errstr, 'Your Composer dependencies require a PHP version') !== false) {
        $message = 'If you have multiple PHP versions installed on your machine, install "tareqas/psym" on the lowest version. It supports PHP >= 7.2';
        echo "\e[41m\e[97m$message\e[0m\n\n";
        die();
    }

    return null !== $prevHandler ? $prevHandler(...func_get_args()) : false;
});

$autoloaderFileUser = getcwd().'/vendor/autoload.php';
$autoloaderFileSf = __DIR__.'/../vendor-sf/autoload.php';
$autoloaderFileDefault = __DIR__.'/../vendor/autoload.php';

if (file_exists($autoloaderFileUser)) {
    $autoloaderUser = require $autoloaderFileUser;
    $autoloaderSf = require $autoloaderFileSf;
} else {
    $autoloaderDefault = require $autoloaderFileDefault;
}
restore_error_handler();

$shell = function () {
    $config = new \Psy\Configuration();
    $config->setAutoCompleter(new \TareqAS\Psym\TabCompletion\AutoCompleter());
    return new \Psy\Shell($config);
};

$sf = new \TareqAS\Psym\SFLoader(getcwd());

if ($sf->isSymfonyApp() && $sf->getKernelInstance()) {
    [$kernel, $container, $doctrine, $em] = $sf->getUsefulServices();
    $commands = $sf->getAllCommands();
    array_unshift($commands, new \TareqAS\Psym\Command\ListEntitiesCommand());

    $sh = $shell();
    $sh->setScopeVariables(compact('kernel', 'container', 'doctrine', 'em'));
    $sh->addCommands($commands);
    $sh->addMatchers([
        new \TareqAS\Psym\TabCompletion\Matcher\SqlFunctionMatcher(),
        new \TareqAS\Psym\TabCompletion\Matcher\MethodChainingMatcher(),
    ]);
    $sh->run();
} else {
    if (isset($autoloaderUser, $autoloaderSf)) {
        $autoloaderUser->unregister();
        $autoloaderSf->unregister();
    }

    if (!isset($autoloaderDefault)) {
        require $autoloaderFileDefault;
    }

    $sh = $shell();
    $sh->addMatchers([
        new \TareqAS\Psym\TabCompletion\Matcher\MethodChainingMatcher(),
    ]);
    $sh->run();
}
